{% extends 'base.html' %}

{% block title %}{{ event.title }} - EcoConnect{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Event Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'events:event_list' %}">Events</a></li>
                    <li class="breadcrumb-item active">{{ event.title }}</li>
                </ol>
            </nav>
            <h1 class="text-success">{{ event.title }}</h1>
            <div class="d-flex align-items-center mb-2">
                <span class="badge bg-success me-2">{{ event.category.name }}</span>
                <span class="badge bg-{{ event.status|yesno:'success,warning,secondary' }}">{{ event.get_status_display }}</span>
                {% if is_full %}
                    <span class="badge bg-danger ms-2">FULL</span>
                {% endif %}
            </div>
        </div>
        <div class="col-md-4 text-end">
            {% if user == event.organizer %}
                <a href="{% url 'events:edit_event' event.id %}" class="btn btn-outline-warning">
                    <i class="fas fa-edit"></i> Edit Event
                </a>
                <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    <i class="fas fa-trash"></i> Delete
                </button>
            {% elif user.is_authenticated %}
                {% if user_joined %}
                    <a href="{% url 'events:leave_event' event.id %}" class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to leave this event?')">
                        <i class="fas fa-minus"></i> Leave Event
                    </a>
                {% else %}
                    {% if is_full %}
                        <button class="btn btn-secondary" disabled>
                            <i class="fas fa-users"></i> Event Full
                        </button>
                    {% elif event.date_time <= timezone.now %}
                        <button class="btn btn-secondary" disabled>
                            <i class="fas fa-clock"></i> Event Passed
                        </button>
                    {% else %}
                        <a href="{% url 'events:join_event' event.id %}" class="btn btn-success">
                            <i class="fas fa-plus"></i> Join Event
                        </a>
                    {% endif %}
                {% endif %}
            {% else %}
                <a href="{% url 'users:login' %}" class="btn btn-outline-success">
                    Login to Join
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Event Details -->
    <div class="row">
        <div class="col-lg-8">
            <!-- Event Info Card -->
            <div class="card card-eco mb-4">
                <div class="card-body">
                    <h5><i class="fas fa-info-circle text-success"></i> Event Information</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong><i class="fas fa-calendar"></i> Date & Time:</strong><br>
                               {{ event.date_time|date:"l, F d, Y" }}<br>
                               {{ event.date_time|date:"g:i A" }}</p>
                            
                            <p><strong><i class="fas fa-map-marker-alt"></i> Location:</strong><br>
                               {{ event.location }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong><i class="fas fa-users"></i> Participants:</strong><br>
                               {{ event.participant_count }} / {{ event.max_participants }} registered
                               {% if is_full %}
                                   <span class="text-danger">(FULL)</span>
                               {% endif %}
                            </p>
                            
                            <p><strong><i class="fas fa-user"></i> Organizer:</strong><br>
                               {{ event.organizer.first_name }} {{ event.organizer.last_name }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-align-left text-success"></i> Description</h5>
                </div>
                <div class="card-body">
                    <p class="lead">{{ event.description|linebreaks }}</p>
                </div>
            </div>

            <!-- Participants List -->
            {% if participants %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-users text-success"></i> Participants ({{ event.participant_count }})</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for participation in participants %}
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center">
                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                    {{ participation.user.first_name|first }}{{ participation.user.last_name|first }}
                                </div>
                                <div>
                                    <strong>{{ participation.user.first_name }} {{ participation.user.last_name }}</strong><br>
                                    <small class="text-muted">Joined {{ participation.joined_date|date:"M d" }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if event.participant_count > 10 %}
                        <p class="text-muted mt-2">
                            <i class="fas fa-plus"></i> And {{ event.participant_count|add:"-10" }} more participant{{ event.participant_count|add:"-10"|pluralize }}
                        </p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i class="fas fa-bolt text-warning"></i> Quick Actions</h6>
                </div>
                <div class="card-body">
                    {% if user.is_authenticated %}
                        {% if user == event.organizer %}
                            <a href="{% url 'events:edit_event' event.id %}" class="btn btn-warning w-100 mb-2">
                                <i class="fas fa-edit"></i> Edit This Event
                            </a>
                            <a href="{% url 'interaction:upload_photo_event' event.id %}" class="btn btn-info w-100 mb-2">
                                <i class="fas fa-camera"></i> Upload Photos
                            </a>
                        {% else %}
                            {% if user_joined %}
                                <a href="{% url 'events:leave_event' event.id %}" class="btn btn-outline-danger w-100 mb-2" onclick="return confirm('Are you sure?')">
                                    <i class="fas fa-minus"></i> Leave Event
                                </a>
                            {% else %}
                                {% if not is_full and event.date_time > timezone.now %}
                                    <a href="{% url 'events:join_event' event.id %}" class="btn btn-success w-100 mb-2">
                                        <i class="fas fa-plus"></i> Join Event
                                    </a>
                                {% endif %}
                            {% endif %}
                            <button class="btn btn-outline-secondary w-100">
                                <i class="fas fa-share"></i> Share Event
                            </button>
                        {% endif %}
                    {% else %}
                        <div class="text-center">
                            <p class="text-muted">Login to join events</p>
                            <a href="{% url 'users:login' %}" class="btn btn-outline-success">Login</a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Event Stats -->
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-chart-bar text-info"></i> Event Stats</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Created:</span>
                        <span>{{ event.created_at|date:"M d, Y" }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Status:</span>
                        <span class="badge bg-{{ event.status|yesno:'success,warning,secondary' }}">
                            {{ event.get_status_display }}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Category:</span>
                        <span>{{ event.category.name }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Capacity:</span>
                        <span>{{ event.participant_count }}/{{ event.max_participants }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Photos Gallery -->
    {% if event.photos.all %}
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-images text-success"></i> Event Photos ({{ event.photos.count }})</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for photo in event.photos.all %}
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <img src="{{ photo.image.url }}" class="card-img-top" alt="{{ photo.caption }}" 
                             style="height: 200px; object-fit: cover;" data-bs-toggle="modal" data-bs-target="#photoModal{{ photo.id }}">
                        <div class="card-body p-2">
                            {% if photo.caption %}
                                <small class="text-muted">{{ photo.caption }}</small><br>
                            {% endif %}
                            <small class="text-muted">
                                <i class="fas fa-user"></i> {{ photo.user.first_name }} 
                                <i class="fas fa-clock ms-2"></i> {{ photo.upload_date|date:"M d" }}
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Photo Modal -->
                <div class="modal fade" id="photoModal{{ photo.id }}" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">{{ event.title }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img src="{{ photo.image.url }}" class="img-fluid" alt="{{ photo.caption }}">
                                {% if photo.caption %}
                                    <p class="mt-3">{{ photo.caption }}</p>
                                {% endif %}
                                <small class="text-muted">
                                    Uploaded by {{ photo.user.first_name }} {{ photo.user.last_name }} 
                                    on {{ photo.upload_date|date:"F d, Y" }}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if user.is_authenticated %}
                <div class="text-center mt-3">
                    <a href="{% url 'interaction:upload_photo_event' event.id %}" class="btn btn-success">
                        <i class="fas fa-camera"></i> Add Photos
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    {% else %}
        {% if user.is_authenticated %}
        <div class="card mb-4">
            <div class="card-body text-center">
                <i class="fas fa-camera fa-3x text-muted mb-3"></i>
                <h6>No photos yet</h6>
                <p class="text-muted">Be the first to share photos from this event!</p>
                <a href="{% url 'interaction:upload_photo_event' event.id %}" class="btn btn-success">
                    <i class="fas fa-camera"></i> Upload Photos
                </a>
            </div>
        </div>
        {% endif %}
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle"></i> Delete Event
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<strong>{{ event.title }}</strong>"?</p>
                <p class="text-muted">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'events:delete_event' event.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete Event
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}